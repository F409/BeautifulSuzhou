<!DOCTYPE html>
<html>
<head>
<title>个人中心</title>
<!-- for-mobile-apps -->
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="keywords" content="Best Store Responsive web template, Bootstrap Web Templates, Flat Web Templates, Android Compatible web template, 
Smartphone Compatible web template, free webdesigns for Nokia, Samsung, LG, SonyEricsson, Motorola web design" />
<script type="application/x-javascript"> addEventListener("load", function() { setTimeout(hideURLbar, 0); }, false);
		function hideURLbar(){ window.scrollTo(0,1); } </script>
<!-- //for-mobile-apps -->
<link href="css/bootstrap.css" rel="stylesheet" type="text/css" media="all" />
<link href="css/style.css" rel="stylesheet" type="text/css" media="all" />
<!-- js -->
<script src="js/jquery.min.js"></script>
<!-- //js -->
<!-- cart -->
	<script src="js/simpleCart.min.js"> </script>
<!-- cart -->
<link rel="stylesheet" type="text/css" href="css/jquery-ui.css">
<!-- for bootstrap working -->
	<script type="text/javascript" src="js/bootstrap-3.1.1.min.js"></script>
<!-- //for bootstrap working -->
<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,300italic,400italic,600,600italic,700,700italic,800,800italic' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Lato:400,100,100italic,300,300italic,400italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
<!-- animation-effect -->
<link href="css/animate.min.css" rel="stylesheet"> 
<script src="js/wow.min.js"></script>
<script>
 new WOW().init();
</script>
<!-- //animation-effect -->
</head>
	
<body>
<!-- header -->
<script type="text/javascript" src="js/header.js"></script>
<!-- //header -->
<!-- breadcrumbs -->
	<div class="breadcrumbs">
		<div class="container">
			<ol class="breadcrumb breadcrumb1 animated wow slideInLeft" data-wow-delay=".5s">
				<li><a href="index.html"><span class="glyphicon glyphicon-home" aria-hidden="true"></span>主页</a></li>
				<li class="active">个人中心</li>
			</ol>
		</div>
	</div>
	<div class="products">
		<div class="container">
			<div id="select1" class="bg-danger col-md-4 products-left ">
				<div class="filter-price animated" data-wow-delay=".5s">
					<h3>账户信息</h3>
					<ul class="dropdown-menu1">
							<li><div id="" style="text-align:center;">&nbsp;</div></li>	
					</ul>
				</div>
			</div>
			<div id="select2" class="col-md-4 products-right">
				<div class="filter-price animated" data-wow-delay=".5s">
					<h3>我的道具</h3>
					<ul class="dropdown-menu1">
						<li><div id="myItemsNum" style="text-align:center;">0</div></li>	
					</ul>
				</div>
			</div>
			<div id="select3" class="col-md-4 products-right">
				<div class="filter-price animated" data-wow-delay=".5s">
					<h3>待处理请求</h3>
					<ul class="dropdown-menu1">
						<li><div  id="doItemsNum" style="text-align:center;">0</div></li>	
					</ul>
				</div>
			</div>
			<div class="clearfix"> </div>
		</div>
	</div>

		<div id="select1c" class="checkout">
			<div class="container" style="text-align:center;">
					<h3>账户名称: <span id="username"></span></h3>
					<h3>账户余额: <span id="balance">￥</span></h3>
			</div>
		</div>

		<div id="select2c" class="checkout hidden">
			<div class="container">
				<div class="checkout-right animated" data-wow-delay=".5s">
					<table class="timetable_sub" id="myItems">
						<thead>
							<tr>
								<th>道具ID</th>	
								<th>道具名称</th>
								<th>装备类型</th>
								<th>发行数量</th>
								<th>流转信息</th>
								<th>简介</th>
								<th>图片</th>
								<th>状态</th>
								<th>交易对象</th>
								<th>交易价格</th>
							</tr>
						</thead>
					</table>
					
				</div>
			</div>
		</div>
		<div id="select3c" class="checkout hidden">
			<div class="container">
				<div class="checkout-right animated" data-wow-delay=".5s">
					<table class="timetable_sub"  id="doItems">
						<thead>
							<tr>
								<th>道具ID</th>	
								<th>道具名称</th>
								<th>装备类型</th>
								<th>发行数量</th>
								<th>购买者</th>
								<th>价格</th>
								<th>流转信息</th>
								<th>简介</th>
								<th>图片</th>
								<th>操作</th>
							</tr>
						</thead>
					</table>
				</div>
			</div>
		</div>
<!-- //breadcrumbs -->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
		<div class="modal-dialog" role="document">
		  <div class="modal-content">
			<div class="modal-header">
			  <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			  <h4 class="modal-title" id="exampleModalLabel">确认出售</h4>
			</div>
			<div class="modal-body">
			  <form>
				<div class="form-group">
				  <label for="itemsID" class="control-label">道具ID:</label>
				  <input type="text" class="form-control" id="itemsID" disabled>
				</div>
				<div class="form-group">
				  <label for="itemsPrice" class="control-label">理想售价:</label>
				  <input type="text" class="form-control" id="itemsPrice"></textarea>
				</div>
			  </form>
			</div>
			<div class="modal-footer">
			  <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
			  <button type="button" class="btn btn-primary" onclick="StartSell()">确认</button>
			</div>
		  </div>
		</div>
	  </div>

<script type="text/javascript">
	function ConfirmSell(id,status){
		let cdata = {};
		cdata['username']=d_username;
		cdata['userType']=d_userType;
		cdata['itemID']=id;
		cdata['confirm']=status==="true";
		let cdataJSON = JSON.stringify(cdata);
		$.ajax({
				type: "POST",
				url: "/api/confirmSellProductByID",
				data: cdataJSON,
				beforeSend: function(request) {
					request.setRequestHeader("content-type", "application/json");
					request.setRequestHeader("authorization","Bearer "+d_token);
				},
				success: function(result) {
					if(result['success']==true){
						alert(result['message']);
						window.location.href='center.html'; 
					}else{
						alert(result['message']);
					}
					
				}
			}); 
	}

	$('#select1').on('click', function () {
		$('#select1').addClass("bg-danger");
		$('#select2').removeClass("bg-danger");
		$('#select3').removeClass("bg-danger");
		$('#select1c').removeClass("hidden");
		$('#select2c').addClass("hidden");
		$('#select3c').addClass("hidden");
	});
	$('#select2').on('click', function () {
		$('#select1').removeClass("bg-danger");
		$('#select2').addClass("bg-danger");
		$('#select3').removeClass("bg-danger");
		$('#select1c').addClass("hidden");
		$('#select2c').removeClass("hidden");
		$('#select3c').addClass("hidden");
	});
	$('#select3').on('click', function () {
		$('#select1').removeClass("bg-danger");
		$('#select2').removeClass("bg-danger");
		$('#select3').addClass("bg-danger");
		$('#select1c').addClass("hidden");
		$('#select2c').addClass("hidden");
		$('#select3c').removeClass("hidden");
	});
	$('#exampleModal').on('show.bs.modal', function (event) {
		var button = $(event.relatedTarget);
		var recipient = button.data('whatever');
		var modal = $(this);
		modal.find('#itemsID').val(recipient);
	});
	function StartSell(){
		let sdata = {};
		sdata['username']=d_username;
		sdata['userType']=d_userType;
		sdata['itemID']=$('#itemsID').val();
		sdata['itemPrice']=$('#itemsPrice').val();
		let sdataJSON = JSON.stringify(sdata);
		$.ajax({
				type: "POST",
				url: "/api/startSellProductByID",
				data: sdataJSON,
				beforeSend: function(request) {
					request.setRequestHeader("content-type", "application/json");
					request.setRequestHeader("authorization","Bearer "+d_token);
				},
				success: function(result) {
					if(result['success']==true){
						alert(result['message']);
						window.location.reload(true); 
					}else{
						alert(result['message']);
					}
					
				}
			});
	}
	function StopSell(id){
		let sdata = {};
		sdata['username']=d_username;
		sdata['userType']=d_userType;
		sdata['itemID']=id;
		let sdataJSON = JSON.stringify(sdata);
		$.ajax({
				type: "POST",
				url: "/api/stopSellProductByID",
				data: sdataJSON,
				beforeSend: function(request) {
					request.setRequestHeader("content-type", "application/json");
					request.setRequestHeader("authorization","Bearer "+d_token);
				},
				success: function(result) {
					if(result['success']==true){
						alert(result['message']);
						window.location.reload(true); 
					}else{
						alert(result['message']);
					}
					
				}
			});
	}

	// 我的道具
	var data = {};
	data['username']=d_username;
	data['userType']=d_userType;
	// data['itemStatus']="0";
	var dataJSON = JSON.stringify(data);
	$.ajax({
		type: "POST",
		url: "/api/getProductsByOwner",
		data: dataJSON,
		beforeSend: function(request) {
			request.setRequestHeader("content-type", "application/json");
			request.setRequestHeader("authorization","Bearer "+d_token);
		},
		success: function(result) {
			if(result['success']==true){

				$("#myItemsNum").html(result['data'].length);

				if(result['data'].length==0){
					$("#myItems").append(
						'<tr class="rem1">'+
							'<td class="invert">暂无</td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
						'</tr>');
				}else{
					for(let i=0;i<result['data'].length;i++){
						$("#myItems").append(
							'<tr class="rem1">'+
								'<td class="invert">'+result['data'][i]['_id']+'</td>'+
								'<td class="invert">'+result['data'][i]['itemName']+'</td>'+
								'<td class="invert">'+result['data'][i]['itemType']+'</td>'+
								'<td class="invert">'+result['data'][i]['itemCount']+'</td>'+
								'<td class="invert" id="myhistory'+i+'"></td>'+
								'<td class="invert">'+result['data'][i]['itemInfo']+'</td>'+
								'<td class="invert-image" id="myimages'+i+'"></td>'+
								'<td class="invert" id="mybutton'+i+'"></td>'+
								'<td class="invert">'+result['data'][i]['buyer']+'</td>'+
								'<td class="invert">'+result['data'][i]['itemPrice']+'</td>'+
							'</tr>'
						);
						for(let j=0;j<result['data'][i]['itemHistory'].length;j++){
							$("#myhistory"+i).append(result['data'][i]['itemHistory'][j]+'</br>');
						}
						for(let k=0;k<result['data'][i]['itemImages'].length;k++){
							$("#myimages"+i).append('<a href="#"><img src="'+result['data'][i]['itemImages'][k]+'" alt=" " class="img-responsive" style="display:inline-block;"/></a>');
						}
						if(result['data'][i]['itemStatus']=="1"){
							$("#mybutton"+i).append('<button type="button" class="btn btn-success upd" data-toggle="modal" data-target="#exampleModal" data-whatever="'+result['data'][i]['_id']+'">可出售</button>');
						}else if(result['data'][i]['itemStatus']=="2"){
							$("#mybutton"+i).append('<button type="button" class="btn btn-danger" onclick="StopSell(\''+result['data'][i]['_id']+'\')">停止出售</button>');
						}else{
							$("#mybutton"+i).append('<button type="button" class="btn btn-warning" disabled>正在出售中</button>');
						}
					}
				}	
			}else{
				alert(result['message']);
			}
		}
	});

	// 待处理道具
	data['itemStatus']="3";
	dataJSON = JSON.stringify(data);
	$.ajax({
		type: "POST",
		url: "/api/getProductsByOwnerAndStatus",
		data: dataJSON,
		beforeSend: function(request) {
			request.setRequestHeader("content-type", "application/json");
			request.setRequestHeader("authorization","Bearer "+d_token);
		},
		success: function(result) {
			if(result['success']==true){

				$("#doItemsNum").html(result['data'].length);

				if(result['data'].length==0){
					$("#doItems").append(
						'<tr class="rem1">'+
							'<td class="invert">暂无</td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
						'</tr>');
				}else{
					for(let i=0;i<result['data'].length;i++){
						$("#doItems").append(
							'<tr class="rem1">'+
								'<td class="invert">'+result['data'][i]['_id']+'</td>'+
								'<td class="invert">'+result['data'][i]['itemName']+'</td>'+
								'<td class="invert">'+result['data'][i]['itemType']+'</td>'+
								'<td class="invert">'+result['data'][i]['itemCount']+'</td>'+
								'<td class="invert">'+result['data'][i]['buyer']+'</td>'+
								'<td class="invert">'+result['data'][i]['itemPrice']+'</td>'+
								'<td class="invert" id="dohistory'+i+'"></td>'+
								'<td class="invert">'+result['data'][i]['itemInfo']+'</td>'+
								'<td class="invert-image" id="doimages'+i+'"></td>'+
								'<td class="invert">是否同意 '+result['data'][i]['buyer']+' 的购买?</br></br><button type="button" class="btn btn-success" onclick="ConfirmSell(\''+result['data'][i]['_id']+'\',\'true\')">同意</button><button type="button" class="btn btn-danger"onclick="ConfirmSell(\''+result['data'][i]['_id']+'\',\'false\')">取消</button></td>'+
							'</tr>'
						);
						for(let j=0;j<result['data'][i]['itemHistory'].length;j++){
							$("#dohistory"+i).append(result['data'][i]['itemHistory'][j]+'</br>');
						}
						for(let k=0;k<result['data'][i]['itemImages'].length;k++){
							console.log(result['data'][i]['itemImages'][k]);
							$("#doimages"+i).append('<a href="#"><img src="'+result['data'][i]['itemImages'][k]+'" alt=" " class="img-responsive" style="display:inline-block;"/></a>');
						}
					}
				}				
			}else{
				alert(result['message']);
			}
		}
	});

	if(!d_token){
		window.location.href='login.html'; 
	}
	if(d_userType=="0"){
		window.location.href='centerSpec.html'; 
	}
	$('#youxi').addClass('hide');
	$('#shichang').addClass('hide');
	$('#DemoTitle').html('交易平台系统');
	$('#username').append(d_username);
	$('#balance').append(d_balance);
</script>
<!-- footer -->
<script type="text/javascript" src="js/footer.js"></script>
<!-- //footer -->
</body>
</html>