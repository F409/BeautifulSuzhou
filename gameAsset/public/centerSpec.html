<!DOCTYPE html>
<html>
<head>
<title>游戏厂商管理平台</title>
<!-- for-mobile-apps -->
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="keywords" content="Best Store Responsive web template, Bootstrap Web Templates, Flat Web Templates, Android Compatible web template, 
Smartphone Compatible web template, free webdesigns for Nokia, Samsung, LG, SonyEricsson, Motorola web design" />
<script type="application/x-javascript"> addEventListener("load", function() { setTimeout(hideURLbar, 0); }, false);
		function hideURLbar(){ window.scrollTo(0,1); } </script>
<!-- //for-mobile-apps -->
<link href="css/bootstrap.css" rel="stylesheet" type="text/css" media="all" />
<link href="css/style.css" rel="stylesheet" type="text/css" media="all" />
<!-- js -->
<script src="js/jquery.min.js"></script>
<!-- //js -->
<!-- cart -->
	<script src="js/simpleCart.min.js"> </script>
<!-- cart -->
<link rel="stylesheet" type="text/css" href="css/jquery-ui.css">
<!-- for bootstrap working -->
	<script type="text/javascript" src="js/bootstrap-3.1.1.min.js"></script>
<!-- //for bootstrap working -->
<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,300italic,400italic,600,600italic,700,700italic,800,800italic' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Lato:400,100,100italic,300,300italic,400italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
<!-- animation-effect -->
<link href="css/animate.min.css" rel="stylesheet"> 
<script src="js/wow.min.js"></script>
<script>
 new WOW().init();
</script>
<link href="css/fileinput.min.css" media="all" rel="stylesheet" type="text/css" />
<script src="js/fileinput.min.js"></script>
<script src="js/zh.js"></script>
<!-- //animation-effect -->
</head>
	
<body>
<!-- header -->
<script type="text/javascript" src="js/header.js"></script>
<!-- //header -->
<!-- breadcrumbs -->
	<div class="breadcrumbs">
		<div class="container">
			<ol class="breadcrumb breadcrumb1 animated wow slideInLeft" data-wow-delay=".5s">
				<li><a href="index.html"><span class="glyphicon glyphicon-home" aria-hidden="true"></span>主页</a></li>
				<li class="active">游戏厂商管理平台</li>
			</ol>
		</div>
	</div>
	<div class="products">
		<div class="container">
			<div id="select1" class="bg-danger col-md-4 products-left ">
				<div class="filter-price animated" data-wow-delay=".5s">
					<h3>所有道具</h3>
					<ul class="dropdown-menu1">
							<li><div id="allItemsNum" style="text-align:center;">0</div></li>	
					</ul>
				</div>
			</div>
			<div id="select2" class="col-md-4 products-right">
				<div class="filter-price animated" data-wow-delay=".5s">
					<h3>待处理请求</h3>
					<ul class="dropdown-menu1">
						<li><div id="doItemsNum" style="text-align:center;">0</div></li>	
					</ul>
				</div>
			</div>
			<div id="select3" class="col-md-4 products-right" data-toggle="modal" data-target="#myModal">
				<div class="filter-price animated" data-wow-delay=".5s">
					<h3>
						生成新道具
					</h3>
					<ul class="dropdown-menu1">
							<li><div id="" style="text-align:center;">&nbsp;</div></li>	
					</ul>
				</div>
			</div>
			<div class="clearfix"> </div>
		</div>
	</div>

		<div id="select1c" class="checkout">
			<div class="container">
				<div class="checkout-right animated" data-wow-delay=".5s">
					<table class="timetable_sub" id="allItems">
						<thead>
							<tr>
								<th>道具ID</th>	
								<th>道具名称</th>
								<th>装备类型</th>
								<th>发行数量</th>
								<th>所有者</th>
								<th>流转信息</th>
								<th>简介</th>
								<th>图片</th>
								<th>状态</th>
							</tr>
						</thead>
					</table>
				</div>
			</div>
		</div>
		<div id="select2c" class="checkout hidden">
			<div class="container">
				<div class="checkout-right animated" data-wow-delay=".5s">
					<table class="timetable_sub" id="doItems">
						<thead>
							<tr>
								<th>道具ID</th>	
								<th>道具名称</th>
								<th>装备类型</th>
								<th>发行数量</th>
								<th>所有者</th>
								<th>购买者</th>
								<th>价格</th>
								<th>流转信息</th>
								<th>简介</th>
								<th>图片</th>
								<th>操作</th>
							</tr>
						</thead>
					</table>
				</div>
			</div>
		</div>

<div class="modal fade bs-example-modal-lg" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	<div class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" id="myModalLabel">生成新道具</h4>
			</div>
			<div class="modal-body">
				<form class="form-horizontal">
					<div class="form-group">
						<label for="itemsName" class="col-sm-2 control-label">道具名称</label>
						<div class="col-sm-10">
							<input type="text" class="form-control" id="itemsName" placeholder="">
						</div>
					</div>
					<div class="form-group">
						<label for="itemsType" class="col-sm-2 control-label">装备类型</label>
						<div class="col-sm-10">
							<input type="text" class="form-control" id="itemsType" placeholder="">
						</div>
					</div>
					<div class="form-group">
						<label for="itemsCount" class="col-sm-2 control-label">发行数量</label>
						<div class="col-sm-10">
							<input type="text" class="form-control" id="itemsCount" placeholder="">
						</div>
					</div>
					<div class="form-group">
						<label for="itemsInfo" class="col-sm-2 control-label">道具简介</label>
						<div class="col-sm-10">
							<input type="text" class="form-control" id="itemsInfo" placeholder="">
						</div>
					</div>
					<div class="form-group">
						<label for="itemsImg" class="col-sm-2 control-label">道具图片</label>
						<div class="col-sm-10">
							<input type="file" id="itemsImg" name="itemsImg[]" multiple>
						</div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal" onclick="StopCreateItems()">取消</button>
				<button type="button" class="btn btn-primary" onclick="CreateItems()">提交</button>
			</div>
		</div>
	</div>
</div>
<!-- //breadcrumbs -->
<script type="text/javascript">
	$("#itemsImg").fileinput({
		language: 'zh',
		showUpload:false, 
		showCancel:false,
		allowedFileExtensions: ['jpg', 'png'],
		maxFileSize:500,
		// maxFileCount: 3
	});
	// 发行道具
	function StartIssue(id){
		let sdata = {};
		sdata['username']=d_username;
		sdata['userType']=d_userType;
		sdata['itemID']=id;
		let sdataJSON = JSON.stringify(sdata);
		$.ajax({
				type: "POST",
				url: "/api/startIssueProductByID",
				data: sdataJSON,
				beforeSend: function(request) {
					request.setRequestHeader("content-type", "application/json");
					request.setRequestHeader("authorization","Bearer "+d_token);
				},
				success: function(result) {
					if(result['success']==true){
						alert('发行 '+id+' 成功');
						window.location.href='centerSpec.html'; 
					}else{
						alert('未知错误');
					}
					
				}
			});

	}
	// 确认结果
	function ConfirmSell(id,status){
		let cdata = {};
		cdata['username']=d_username;
		cdata['userType']=d_userType;
		cdata['itemID']=id;
		cdata['approve']=status==="true";
		let cdataJSON = JSON.stringify(cdata);
		$.ajax({
				type: "POST",
				url: "/api/approveSellProductByID",
				data: cdataJSON,
				beforeSend: function(request) {
					request.setRequestHeader("content-type", "application/json");
					request.setRequestHeader("authorization","Bearer "+d_token);
				},
				success: function(result) {
					if(result['success']==true){
						alert('执行成功 ');
						window.location.href='centerSpec.html'; 
					}else{
						alert('未知错误');
					}
					
				}
			}); 
	}

	$('#select1').on('click', function () {
		$('#select1').addClass("bg-danger");
		$('#select2').removeClass("bg-danger");
		$('#select3').removeClass("bg-danger");
		$('#select1c').removeClass("hidden");
		$('#select2c').addClass("hidden");
	});
	$('#select2').on('click', function () {
		$('#select1').removeClass("bg-danger");
		$('#select2').addClass("bg-danger");
		$('#select3').removeClass("bg-danger");
		$('#select1c').addClass("hidden");
		$('#select2c').removeClass("hidden");
	});
	$('#myModal').on('show.bs.modal', function (event) {
		$('#select1').removeClass("bg-danger");
		$('#select2').removeClass("bg-danger");
		$('#select3').addClass("bg-danger");
	});
	// 生成新道具
	function CreateItems(){
		var images = new Array()
		var files = $("#itemsImg")[0].files;

		for (var i = 0; i < files.length; i++) {
			let file = files[i];
			let reader = new FileReader();
			reader.readAsDataURL(file);
			reader.onload = function(e) {
				images.push(reader.result);
			};
		}

		let cidata = {};
		cidata['username']=d_username;
		cidata['userType']=d_userType;
		cidata['itemName']=$("#itemsName").val();
		cidata['itemType']=$("#itemsType").val();
		cidata['itemCount']=$("#itemsCount").val();
		cidata['owner']=d_username;
		cidata['itemCompany']=d_username;
		cidata['itemInfo']=$("#itemsInfo").val();

		setTimeout(function(){
			cidata["itemImages"]=images;
			let cidataJSON = JSON.stringify(cidata);
			$.ajax({
				type: "POST",
				url: "/api/createItem",
				data: cidataJSON,
				beforeSend: function(request) {
					request.setRequestHeader("content-type", "application/json");
					request.setRequestHeader("authorization","Bearer "+d_token);
				},
				success: function(result) {
					if(result['success']==true){
						alert('创建成功 ');
						window.location.href='centerSpec.html'; 
					}else{
						alert('未知错误');
					}
					
				}
			}); 
		},3000);
	}

	function StopCreateItems(){
		$('#select1').addClass("bg-danger");
		$('#select2').removeClass("bg-danger");
		$('#select3').removeClass("bg-danger");
		$('#select1c').removeClass("hidden");
		$('#select2c').addClass("hidden");
	}
	
	// 所有道具
	var data = {};
	data['username']=d_username;
	data['userType']=d_userType;
	// data['itemStatus']="0";
	var dataJSON = JSON.stringify(data);
	$.ajax({
		type: "POST",
		url: "/api/getProductsByCompany",
		data: dataJSON,
		beforeSend: function(request) {
			request.setRequestHeader("content-type", "application/json");
			request.setRequestHeader("authorization","Bearer "+d_token);
		},
		success: function(result) {
			if(result['success']==true){

				$("#allItemsNum").html(result['data'].length);

				if(result['data'].length==0){
					$("#allItems").append(
						'<tr class="rem1">'+
							'<td class="invert">暂无</td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
						'</tr>');
				}else{
					for(let i=0;i<result['data'].length;i++){
						$("#allItems").append(
							'<tr class="rem1">'+
								'<td class="invert">'+result['data'][i]['_id']+'</td>'+
								'<td class="invert">'+result['data'][i]['itemName']+'</td>'+
								'<td class="invert">'+result['data'][i]['itemType']+'</td>'+
								'<td class="invert">'+result['data'][i]['itemCount']+'</td>'+
								'<td class="invert">'+result['data'][i]['owner']+'</td>'+
								'<td class="invert" id="history'+i+'"></td>'+
								'<td class="invert">'+result['data'][i]['itemInfo']+'</td>'+
								'<td class="invert-image" id="images'+i+'"></td>'+
								'<td class="invert" id="button'+i+'"></td>'+
							'</tr>'
						);
						for(let j=0;j<result['data'][i]['itemHistory'].length;j++){
							$("#history"+i).append(result['data'][i]['itemHistory'][j]+'</br>');
						}
						for(let k=0;k<result['data'][i]['itemImages'].length;k++){
							$("#images"+i).append('<a href="#"><img src="'+result['data'][i]['itemImages'][k]+'" alt=" " class="img-responsive" style="display:inline-block;"/></a>');
						}
						if(result['data'][i]['itemStatus']=="0"){
							$("#button"+i).append('<button type="button" class="btn btn-success" onclick="StartIssue(\''+result['data'][i]['_id']+'\')">可发行</button>');
						}else{
							$("#button"+i).append('<button type="button" class="btn btn-warning" disabled>已发行</button>');
						}
					}
				}	
			}else{
				alert('获取道具列表错误！');
			}
		}
	});


	// 待处理道具
	data['itemStatus']="4";
	dataJSON = JSON.stringify(data);
	$.ajax({
		type: "POST",
		url: "/api/getProductsByCompanyAndStatus",
		data: dataJSON,
		beforeSend: function(request) {
			request.setRequestHeader("content-type", "application/json");
			request.setRequestHeader("authorization","Bearer "+d_token);
		},
		success: function(result) {
			if(result['success']==true){

				$("#doItemsNum").html(result['data'].length);

				if(result['data'].length==0){
					$("#doItems").append(
						'<tr class="rem1">'+
							'<td class="invert">暂无</td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
							'<td class="invert"></td>'+
						'</tr>');
				}else{
					for(let i=0;i<result['data'].length;i++){
						$("#doItems").append(
							'<tr class="rem1">'+
								'<td class="invert">'+result['data'][i]['_id']+'</td>'+
								'<td class="invert">'+result['data'][i]['itemName']+'</td>'+
								'<td class="invert">'+result['data'][i]['itemType']+'</td>'+
								'<td class="invert">'+result['data'][i]['itemCount']+'</td>'+
								'<td class="invert">'+result['data'][i]['owner']+'</td>'+
								'<td class="invert">'+result['data'][i]['buyer']+'</td>'+
								'<td class="invert">'+result['data'][i]['itemPrice']+'</td>'+
								'<td class="invert" id="dohistory'+i+'"></td>'+
								'<td class="invert">'+result['data'][i]['itemInfo']+'</td>'+
								'<td class="invert-image" id="doimages'+i+'"></td>'+
								'<td class="invert">是否同意 '+result['data'][i]['buyer']+' 的购买?</br></br><button type="button" class="btn btn-success" onclick="ConfirmSell("'+result['data'][i]['_id']+'","true")">同意</button><button type="button" class="btn btn-danger"onclick="ConfirmSell("'+result['data'][i]['_id']+'","false")">取消</button></td>'+
							'</tr>'
						);
						for(let j=0;j<result['data'][i]['itemHistory'].length;j++){
							$("#dohistory"+i).append(result['data'][i]['itemHistory'][j]+'</br>');
						}
						for(let k=0;k<result['data'][i]['itemImages'].length;k++){
							console.log(result['data'][i]['itemImages'][k]);
							$("#doimages"+i).append('<a href="#"><img src="'+result['data'][i]['itemImages'][k]+'" alt=" " class="img-responsive" style="display:inline-block;"/></a>');
						}
					}
				}				
			}else{
				alert('获取道具列表错误！');
			}
		}
	});
	// 标题
	$('#DemoTitle').html('游戏厂商系统');
	if(!d_token){
		window.location.href='login.html'; 
	}
	if(d_userType=="1"){
		window.location.href='center.html'; 
	}
</script>
<!-- footer -->
<script type="text/javascript" src="js/footer.js"></script>
<!-- //footer -->
</body>
</html>